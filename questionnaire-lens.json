{
  "resourceType": "Library",
  "id": "questionnaire-lens",
  "meta": {
    "profile": [
      "http://hl7.eu/fhir/ig/gravitate-health/StructureDefinition/lens"
    ]
  },
  "extension": [
    {
      "url": "http://hl7.eu/fhir/ig/gravitate-health/StructureDefinition/lee-version",
      "valueString": "dev"
    }
  ],
  "url": "https://gravitate-health.lst.tfo.upm.es/ips/api/fhir/Library/592",
  "identifier": [
    {
      "system": "http://gravitate-health.lst.tfo.upm.es",
      "value": "questionnaire-lens"
    }
  ],
  "version": "0.0.1",
  "name": "High Risk Medication Lens",
  "_name": {
    "extension": [
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "es"
          },
          {
            "url": "content",
            "valueString": "Lente de medicamentos de alto riesgo"
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "pt"
          },
          {
            "url": "content",
            "valueString": "Lente de medicamentos de alto risco"
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "da"
          },
          {
            "url": "content",
            "valueString": "Højrisiko medicin linse"
          }
        ]
      }
    ]
  },
  "date": "2026-02-03T11:02:12.710Z",
  "title": "Questionnaire Lens",
  "_title": {
    "extension": [
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "es"
          },
          {
            "url": "content",
            "valueString": "Lente de cuestionario de seguridad"
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "pt"
          },
          {
            "url": "content",
            "valueString": "Lente de questionário de segurança"
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "da"
          },
          {
            "url": "content",
            "valueString": "Sikkerhedsspørgeskema linse"
          }
        ]
      }
    ]
  },
  "status": "draft",
  "experimental": true,
  "type": {
    "coding": [
      {
        "code": "logical-library"
      }
    ]
  },
  "publisher": "Gravitate Health Project - UPM Team",
  "contact": [
    {
      "name": "Gravitate Health",
      "telecom": [
        {
          "system": "url",
          "value": "https://www.gravitatehealth.eu/"
        }
      ]
    }
  ],
  "description": "A lens that adds safety questionnaire links for high-risk medications that may cause serious side effects",
  "_description": {
    "extension": [
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "es"
          },
          {
            "url": "content",
            "valueString": "Una lente que añade enlaces a cuestionarios de seguridad para medicamentos de alto riesgo que pueden causar efectos secundarios graves."
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "pt"
          },
          {
            "url": "content",
            "valueString": "Uma lente que adiciona links para questionários de segurança para medicamentos de alto risco que podem causar efeitos secundários graves."
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "da"
          },
          {
            "url": "content",
            "valueString": "En linse der tilføjer links til sikkerhedsspørgeskemaer for højrisiko medicin der kan forårsage alvorlige bivirkninger."
          }
        ]
      }
    ]
  },
  "jurisdiction": [
    {
      "coding": [
        {
          "code": "EU",
          "system": "urn:iso:std:iso:3166"
        }
      ]
    }
  ],
  "purpose": "Add safety questionnaire links to ePIs for high-risk medications to help patients report side effects",
  "_purpose": {
    "extension": [
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "es"
          },
          {
            "url": "content",
            "valueString": "Añadir enlaces a cuestionarios de seguridad en ePIs para medicamentos de alto riesgo para ayudar a los pacientes a reportar efectos secundarios."
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "pt"
          },
          {
            "url": "content",
            "valueString": "Adicionar links para questionários de segurança em ePIs para medicamentos de alto risco para ajudar os pacientes a reportar efeitos secundários."
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "da"
          },
          {
            "url": "content",
            "valueString": "Tilføj links til sikkerhedsspørgeskemaer i ePI'er for højrisiko medicin for at hjælpe patienter med at rapportere bivirkninger."
          }
        ]
      }
    ]
  },
  "usage": "This lens requires a preprocessed ePI, and an IPS to work. You can import this lens directly to your FHIR Server which suports Library Resource type.",
  "_usage": {
    "extension": [
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "es"
          },
          {
            "url": "content",
            "valueString": "Esta lente requiere una ePI preprocesada y un IPS para funcionar. Puedes importar esta lente directamente en tu servidor FHIR que soporte el tipo de recurso Library."
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "pt"
          },
          {
            "url": "content",
            "valueString": "Esta lente requer uma ePI pré-processada e um IPS para funcionar. Podes importar esta lente diretamente para o teu servidor FHIR que suporte o tipo de recurso Library."
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "da"
          },
          {
            "url": "content",
            "valueString": "Denne linse kræver en forbehandlet ePI og en IPS for at fungere. Du kan importere denne linse direkte til din FHIR-server, som understøtter ressource-typen Library."
          }
        ]
      }
    ]
  },
  "copyright": "© 2024 Gravitate Health",
  "parameter": [
    {
      "use": "in",
      "documentation": "parameter if it exists",
      "type": "CodeableConcept"
    }
  ],
  "content": [
    {
      "contentType": "application/javascript",
      "data": "bGV0IHB2RGF0YSA9IHB2OwpsZXQgaHRtbERhdGEgPSBodG1sOwoKbGV0IGVwaURhdGEgPSBlcGk7CmxldCBpcHNEYXRhID0gaXBzOwpsZXQgbGFuZyA9ICIiOyAgLy8gRGVmYXVsdCBsYW5ndWFnZSwgd2lsbCBiZSBzZXQgYnkgZVBJCgovLyAtLS0gTGFuZ3VhZ2UgZGljdGlvbmFyeSBmb3IgdXNlci1mYWNpbmcgbWVzc2FnZXMgLS0tCmNvbnN0IG1lc3NhZ2VEaWN0ID0gewogICAgZW46IHsKICAgICAgICBiYW5uZXJXYXJuaW5nOiAi4pqg77iPIFRoaXMgbWVkaWNhdGlvbiBtYXkgY2F1c2UgaGlnaC1yaXNrIHNpZGUgZWZmZWN0cy4iLAogICAgICAgIHF1ZXN0aW9ubmFpcmVMaW5rOiAiRmlsbCBvdXQgc2FmZXR5IHF1ZXN0aW9ubmFpcmUiLAogICAgICAgIGZpbGxRdWVzdGlvbm5haXJlOiAi8J+TnSBGaWxsIG91dCBzYWZldHkgcXVlc3Rpb25uYWlyZSIKICAgIH0sCiAgICBlczogewogICAgICAgIGJhbm5lcldhcm5pbmc6ICLimqDvuI8gRXN0ZSBtZWRpY2FtZW50byBwdWVkZSBjYXVzYXIgZWZlY3RvcyBzZWN1bmRhcmlvcyBkZSBhbHRvIHJpZXNnby4iLAogICAgICAgIHF1ZXN0aW9ubmFpcmVMaW5rOiAiUmVsbGVuYXIgY3Vlc3Rpb25hcmlvIGRlIHNlZ3VyaWRhZCIsCiAgICAgICAgZmlsbFF1ZXN0aW9ubmFpcmU6ICLwn5OdIFJlbGxlbmFyIGN1ZXN0aW9uYXJpbyBkZSBzZWd1cmlkYWQiCiAgICB9LAogICAgcHQ6IHsKICAgICAgICBiYW5uZXJXYXJuaW5nOiAi4pqg77iPIEVzdGUgbWVkaWNhbWVudG8gcG9kZSBjYXVzYXIgZWZlaXRvcyBzZWN1bmTDoXJpb3MgZGUgYWx0byByaXNjby4iLAogICAgICAgIHF1ZXN0aW9ubmFpcmVMaW5rOiAiUHJlZW5jaGVyIHF1ZXN0aW9uw6FyaW8gZGUgc2VndXJhbsOnYSIsCiAgICAgICAgZmlsbFF1ZXN0aW9ubmFpcmU6ICLwn5OdIFByZWVuY2hlciBxdWVzdGlvbsOhcmlvIGRlIHNlZ3VyYW7Dp2EiCiAgICB9LAogICAgZGE6IHsKICAgICAgICBiYW5uZXJXYXJuaW5nOiAi4pqg77iPIERlbm5lIG1lZGljaW4ga2FuIGZvcsOlcnNhZ2UgYWx2b3JsaWdlIGJpdmlya25pbmdlci4iLAogICAgICAgIHF1ZXN0aW9ubmFpcmVMaW5rOiAiVWRmeWxkIHNpa2tlcmhlZHNzcMO4cmdlc2tlbWEiLAogICAgICAgIGZpbGxRdWVzdGlvbm5haXJlOiAi8J+TnSBVZGZ5bGQgc2lra2VyaGVkc3Nww7hyZ2Vza2VtYSIKICAgIH0KfTsKCi8vIFN0YXRlIHRvIHRyYWNrIGlmIHF1ZXN0aW9ubmFpcmUgbGluayB3YXMgYWRkZWQKbGV0IGxpbmtBZGRlZCA9IGZhbHNlOwoKbGV0IGdldFNwZWNpZmljYXRpb24gPSAoKSA9PiB7CiAgICByZXR1cm4gIjIuMC4zLXF1ZXN0aW9ubmFpcmUtYmFubmVyIjsKfTsKCi8vIC0tLSBVdGlsaXR5OiBHZXQgbGFuZ3VhZ2Uga2V5IGZyb20gZGV0ZWN0ZWQgbGFuZ3VhZ2UgLS0tCmNvbnN0IGdldExhbmdLZXkgPSAobGFuZ3VhZ2UpID0+IHsKICAgIGlmIChsYW5ndWFnZT8uc3RhcnRzV2l0aCgicHQiKSkgcmV0dXJuICJwdCI7CiAgICBpZiAobGFuZ3VhZ2U/LnN0YXJ0c1dpdGgoImVzIikpIHJldHVybiAiZXMiOwogICAgaWYgKGxhbmd1YWdlPy5zdGFydHNXaXRoKCJkYSIpKSByZXR1cm4gImRhIjsKICAgIHJldHVybiAiZW4iOyAvLyBEZWZhdWx0IHRvIEVuZ2xpc2gKfTsKCi8vZG9jdW1lbnQsIGh0bWxEYXRhLCBiYW5uZXJIVE1MCi8vCmNvbnN0IGluc2VydFF1ZXN0aW9ubmFpcmVMaW5rID0gKGxpc3RPZkNhdGVnb3JpZXMsIGxhbmd1YWdlLCBkb2N1bWVudCwgcmVzcG9uc2UpID0+IHsKICAgIGNvbnN0IGxhbmdLZXkgPSBnZXRMYW5nS2V5KGxhbmd1YWdlKTsKICAgIGNvbnN0IG1lc3NhZ2VzID0gbWVzc2FnZURpY3RbbGFuZ0tleV07CiAgICBjb25zdCBsaW5rSFRNTCA9ICJodHRwczovL2V4YW1wbGUub3JnL3F1ZXN0aW9ubmFpcmUvaGlnaC1yaXNrIjsKICAgIGxldCBzaG91bGRBcHBlbmQgPSBmYWxzZTsgLy9mb3IgZnV0dXJlIHVzYWdlCiAgICBsZXQgZm91bmRDYXRlZ29yeSA9IGZhbHNlOwogICAgY29uc29sZS5sb2cobGlzdE9mQ2F0ZWdvcmllcykKICAgIGNvbnNvbGUubG9nKGxpc3RPZkNhdGVnb3JpZXMubGVuZ3RoKQogICAgbGlzdE9mQ2F0ZWdvcmllcy5mb3JFYWNoKChjbGFzc05hbWUpID0+IHsKICAgICAgICBpZiAoCiAgICAgICAgICAgIHJlc3BvbnNlLmluY2x1ZGVzKGBjbGFzcz0iJHtjbGFzc05hbWV9YCkgfHwKICAgICAgICAgICAgcmVzcG9uc2UuaW5jbHVkZXMoYGNsYXNzPScke2NsYXNzTmFtZX1gKQogICAgICAgICkgewogICAgICAgICAgICBjb25zdCBlbGVtZW50cyA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoY2xhc3NOYW1lKTsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBlbGVtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgZWwgPSBlbGVtZW50c1tpXTsKICAgICAgICAgICAgICAgIGNvbnN0IGxpbmsgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhIik7CiAgICAgICAgICAgICAgICBsaW5rLnNldEF0dHJpYnV0ZSgiaHJlZiIsIGxpbmtIVE1MKTsKICAgICAgICAgICAgICAgIGxpbmsuc2V0QXR0cmlidXRlKCJ0YXJnZXQiLCAiX2JsYW5rIik7CiAgICAgICAgICAgICAgICBsaW5rLnNldEF0dHJpYnV0ZSgiY2xhc3MiLCAicXVlc3Rpb25uYWlyZS1sZW5zIik7CgogICAgICAgICAgICAgICAgaWYgKHNob3VsZEFwcGVuZCkgewogICAgICAgICAgICAgICAgICAgIC8vIEFwcGVuZCB0aGUgbGluayBhcyBhIG5ldyBlbGVtZW50IGluc2lkZSB0aGUgZXhpc3RpbmcgZWxlbWVudAogICAgICAgICAgICAgICAgICAgIGxpbmsuaW5uZXJIVE1MID0gbWVzc2FnZXMuZmlsbFF1ZXN0aW9ubmFpcmU7CiAgICAgICAgICAgICAgICAgICAgZWwuYXBwZW5kQ2hpbGQobGluayk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIFdyYXAgdGhlIGV4aXN0aW5nIGNvbnRlbnRzIG9mIHRoZSBlbGVtZW50IGluIHRoZSBsaW5rCiAgICAgICAgICAgICAgICAgICAgbGluay5pbm5lckhUTUwgPSBlbC5pbm5lckhUTUw7CiAgICAgICAgICAgICAgICAgICAgZWwuaW5uZXJIVE1MID0gIiI7CiAgICAgICAgICAgICAgICAgICAgZWwuYXBwZW5kQ2hpbGQobGluayk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm91bmRDYXRlZ29yeSA9IHRydWU7CiAgICAgICAgfQogICAgfSk7CgogICAgLy8gTm8gbWF0Y2hpbmcgY2F0ZWdvcnkgdGFncyDihpIgaW5qZWN0IGJhbm5lciBhdCB0b3AKICAgIGlmICghZm91bmRDYXRlZ29yeSkgewogICAgICAgIGNvbnN0IGJhbm5lckRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgIGJhbm5lckRpdi5pbm5lckhUTUwgPSBgCiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImFsZXJ0LWJhbm5lciBxdWVzdGlvbm5haXJlLWxlbnMiIHN0eWxlPSJiYWNrZ3JvdW5kLWNvbG9yOiNmZmRkZGQ7cGFkZGluZzoxZW07Ym9yZGVyOjFweCBzb2xpZCAjZmY4ODg4O21hcmdpbi1ib3R0b206MWVtOyI+CiAgICAgICAgICAgICAgICAke21lc3NhZ2VzLmJhbm5lcldhcm5pbmd9CiAgICAgICAgICAgICAgICA8YSBocmVmPSIke2xpbmtIVE1MfSIgdGFyZ2V0PSJfYmxhbmsiIHN0eWxlPSJtYXJnaW4tbGVmdDogMWVtOyI+JHttZXNzYWdlcy5xdWVzdGlvbm5haXJlTGlua308L2E+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgIGA7CgogICAgICAgIGNvbnN0IGJvZHkgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCJib2R5Iik7CiAgICAgICAgaWYgKGJvZHkpIHsKICAgICAgICAgICAgYm9keS5pbnNlcnRCZWZvcmUoYmFubmVyRGl2LCBib2R5LmZpcnN0Q2hpbGQpOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBDbGVhbiBoZWFkIChzYW1lIGFzIHlvdXIgb3JpZ2luYWwgbG9naWMpCiAgICBpZiAoZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImhlYWQiKS5sZW5ndGggPiAwKSB7CiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImhlYWQiKVswXS5yZW1vdmUoKTsKICAgIH0KCiAgICAvLyBFeHRyYWN0IEhUTUwgcmVzdWx0CiAgICBpZiAoZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImJvZHkiKS5sZW5ndGggPiAwKSB7CiAgICAgICAgcmVzcG9uc2UgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiYm9keSIpWzBdLmlubmVySFRNTDsKICAgICAgICBjb25zb2xlLmxvZygiUmVzcG9uc2U6ICIgKyByZXNwb25zZSk7CiAgICB9IGVsc2UgewogICAgICAgIGNvbnNvbGUubG9nKCJSZXNwb25zZTogIiArIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5pbm5lckhUTUwpOwogICAgICAgIHJlc3BvbnNlID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmlubmVySFRNTDsKICAgIH0KCiAgICBpZiAoIXJlc3BvbnNlIHx8IHJlc3BvbnNlLnRyaW0oKSA9PT0gIiIpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkFubm90YXRpb24gcHJvY2VzcyBmYWlsZWQ6IGVtcHR5IG9yIG51bGwgcmVzcG9uc2UiKTsKICAgIH0KCiAgICByZXR1cm4gcmVzcG9uc2U7Cn07CgpsZXQgZW5oYW5jZSA9IGFzeW5jICgpID0+IHsKCiAgICBpZiAoIWVwaURhdGEgfHwgIWVwaURhdGEuZW50cnkgfHwgZXBpRGF0YS5lbnRyeS5sZW5ndGggPT09IDApIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImVQSSBpcyBlbXB0eSBvciBpbnZhbGlkLiIpOwogICAgfQogICAgbGV0IGxpc3RPZkNhdGVnb3JpZXNUb1NlYXJjaCA9IFsiZ3Jhdi0zIl07IC8vd2hhdCB0byBsb29rIGluIGV4dGVuc2lvbnMgLW1hZGUgdXAgY29kZSBiZWNhdXNlIHRoZXJlIGlzIG5vbmUKCiAgICAvLyBNYXRjaCBsaXN0cwogICAgY29uc3QgQlVORExFX0lERU5USUZJRVJfTElTVCA9IFsiZXBpYnVuZGxlLTEyMyIsICJlcGlidW5kbGUtYWJjIl07CiAgICBjb25zdCBQUk9EVUNUX0lERU5USUZJRVJfTElTVCA9IFsiQ0lULTIwNDQ0NyIsICJSSVMtMTk3MzYxIl07CgoKICAgIGxldCBtYXRjaEZvdW5kID0gZmFsc2U7CgogICAgLy8gMS4gQ2hlY2sgQ29tcG9zaXRpb24ubGFuZ3VhZ2UKICAgIGVwaURhdGEuZW50cnk/LmZvckVhY2goKGVudHJ5KSA9PiB7CiAgICAgICAgY29uc3QgcmVzID0gZW50cnkucmVzb3VyY2U7CiAgICAgICAgaWYgKHJlcz8ucmVzb3VyY2VUeXBlID09PSAiQ29tcG9zaXRpb24iICYmIHJlcy5sYW5ndWFnZSkgewogICAgICAgICAgICBsYW5nID0gcmVzLmxhbmd1YWdlOwogICAgICAgICAgICBjb25zb2xlLmxvZygi8J+MjSBEZXRlY3RlZCBmcm9tIENvbXBvc2l0aW9uLmxhbmd1YWdlOiIsIGxhbmcpOwogICAgICAgIH0KICAgIH0pOwoKICAgIC8vIDIuIElmIG5vdCBmb3VuZCwgY2hlY2sgQnVuZGxlLmxhbmd1YWdlCiAgICBpZiAoIWxhbmcgJiYgZXBpRGF0YS5sYW5ndWFnZSkgewogICAgICAgIGxhbmcgPSBlcGlEYXRhLmxhbmd1YWdlOwogICAgICAgIGNvbnNvbGUubG9nKCLwn4yNIERldGVjdGVkIGZyb20gQnVuZGxlLmxhbmd1YWdlOiIsIGxhbmcpOwogICAgfQoKICAgIC8vIDMuIEZhbGxiYWNrIG1lc3NhZ2UKICAgIGlmICghbGFuZykgewogICAgICAgIGNvbnNvbGUud2Fybigi4pqg77iPIE5vIGxhbmd1YWdlIGRldGVjdGVkIGluIENvbXBvc2l0aW9uIG9yIEJ1bmRsZS4iKTsKICAgIH0KCiAgICAvLyBDaGVjayBidW5kbGUuaWRlbnRpZmllci52YWx1ZQogICAgaWYgKAogICAgICAgIGVwaURhdGEuaWRlbnRpZmllciAmJgogICAgICAgIEJVTkRMRV9JREVOVElGSUVSX0xJU1QuaW5jbHVkZXMoZXBpRGF0YS5pZGVudGlmaWVyLnZhbHVlKQogICAgKSB7CiAgICAgICAgY29uc29sZS5sb2coIvCflJcgTWF0Y2hlZCBlUEkgQnVuZGxlLmlkZW50aWZpZXI6IiwgZXBpRGF0YS5pZGVudGlmaWVyLnZhbHVlKTsKICAgICAgICBtYXRjaEZvdW5kID0gdHJ1ZTsKICAgIH0KCiAgICAvLyBDaGVjayBNZWRpY2luYWxQcm9kdWN0RGVmaW5pdGlvbi5pZGVudGlmaWVyLnZhbHVlCiAgICBlcGlEYXRhLmVudHJ5LmZvckVhY2goKGVudHJ5KSA9PiB7CiAgICAgICAgY29uc3QgcmVzID0gZW50cnkucmVzb3VyY2U7CiAgICAgICAgaWYgKHJlcz8ucmVzb3VyY2VUeXBlID09PSAiTWVkaWNpbmFsUHJvZHVjdERlZmluaXRpb24iKSB7CiAgICAgICAgICAgIGNvbnN0IGlkcyA9IHJlcy5pZGVudGlmaWVyIHx8IFtdOwogICAgICAgICAgICBpZHMuZm9yRWFjaCgoaWQpID0+IHsKICAgICAgICAgICAgICAgIGlmIChQUk9EVUNUX0lERU5USUZJRVJfTElTVC5pbmNsdWRlcyhpZC52YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygi8J+SiiBNYXRjaGVkIE1lZGljaW5hbFByb2R1Y3REZWZpbml0aW9uLmlkZW50aWZpZXI6IiwgaWQudmFsdWUpOwogICAgICAgICAgICAgICAgICAgIG1hdGNoRm91bmQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9KTsKCiAgICAvLyBlUEkgdHJhc2xhdGlvbiBmcm9tIHRlcm1pbm9sb2d5IGNvZGVzIHRvIHRoZWlyIGh1bWFuIHJlZGFibGUgdHJhbnNsYXRpb25zIGluIHRoZSBzZWN0aW9ucwogICAgLy8gaW4gdGhpcyBjYXNlLCBpZiBpcyBkb2VzIG5vdCBmaW5kIGEgcGxhY2UsIGFkZHMgaXQgdG8gdGhlIHRvcCBvZiB0aGUgZVBJCiAgICBsZXQgY29tcG9zaXRpb25zID0gMDsKICAgIGxldCBjYXRlZ29yaWVzID0gW107CiAgICBlcGkuZW50cnkuZm9yRWFjaCgoZW50cnkpID0+IHsKICAgICAgICBpZiAoZW50cnkucmVzb3VyY2UucmVzb3VyY2VUeXBlID09ICJDb21wb3NpdGlvbiIpIHsKICAgICAgICAgICAgY29tcG9zaXRpb25zKys7CiAgICAgICAgICAgIC8vSXRlcmF0ZWQgdGhyb3VnaCB0aGUgQ29uZGl0aW9uIGVsZW1lbnQgc2VhcmNoaW5nIGZvciBjb25kaXRpb25zCiAgICAgICAgICAgIGVudHJ5LnJlc291cmNlLmV4dGVuc2lvbi5mb3JFYWNoKChlbGVtZW50KSA9PiB7CgogICAgICAgICAgICAgICAgLy8gQ2hlY2sgaWYgdGhlIHBvc2l0aW9uIG9mIHRoZSBleHRlbnNpb25bMV0gaXMgY29ycmVjdAogICAgICAgICAgICAgICAgaWYgKGVsZW1lbnQuZXh0ZW5zaW9uWzFdLnVybCA9PSAiY29uY2VwdCIpIHsKICAgICAgICAgICAgICAgICAgICAvLyBTZWFyY2ggdGhyb3VnaCB0aGUgZGlmZmVyZW50IHRlcm1pbm9sb2dpZXMgdGhhdCBtYXkgYmUgYXZhaWJsZSB0byBjaGVjayBpbiB0aGUgY29uZGl0aW9uCiAgICAgICAgICAgICAgICAgICAgaWYgKGVsZW1lbnQuZXh0ZW5zaW9uWzFdLnZhbHVlQ29kZWFibGVSZWZlcmVuY2UuY29uY2VwdCAhPSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5leHRlbnNpb25bMV0udmFsdWVDb2RlYWJsZVJlZmVyZW5jZS5jb25jZXB0LmNvZGluZy5mb3JFYWNoKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKGNvZGluZykgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJFeHRlbnNpb246ICIgKyBlbGVtZW50LmV4dGVuc2lvblswXS52YWx1ZVN0cmluZyArICI6IiArIGNvZGluZy5jb2RlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIHRoZSBjb2RlIGlzIGluIHRoZSBsaXN0IG9mIGNhdGVnb3JpZXMgdG8gc2VhcmNoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxpc3RPZkNhdGVnb3JpZXNUb1NlYXJjaC5pbmNsdWRlcyhjb2RpbmcuY29kZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2hlY2sgaWYgdGhlIGNhdGVnb3J5IGlzIGFscmVhZHkgaW4gdGhlIGxpc3Qgb2YgY2F0ZWdvcmllcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXRlZ29yaWVzLnB1c2goZWxlbWVudC5leHRlbnNpb25bMF0udmFsdWVTdHJpbmcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0pOwogICAgaWYgKGNvbXBvc2l0aW9ucyA9PSAwKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdCYWQgZVBJOiBubyBjYXRlZ29yeSAiQ29tcG9zaXRpb24iIGZvdW5kJyk7CiAgICB9CgogICAgaWYgKCFtYXRjaEZvdW5kKSB7CiAgICAgICAgY29uc29sZS5sb2coImVQSSBpcyBub3QgZm9yIGEgaGlnaC1yaXNrIHNpZGUgZWZmZWN0IG1lZGljYXRpb24iKTsKICAgICAgICBsaW5rQWRkZWQgPSBmYWxzZTsKICAgICAgICByZXR1cm4gaHRtbERhdGE7CiAgICB9CgogICAgZWxzZSB7CiAgICAgICAgbGlua0FkZGVkID0gdHJ1ZTsKCiAgICAgICAgbGV0IHJlc3BvbnNlID0gaHRtbERhdGE7CiAgICAgICAgbGV0IGRvY3VtZW50OwoKICAgICAgICBpZiAodHlwZW9mIHdpbmRvdyA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgbGV0IGpzZG9tID0gYXdhaXQgaW1wb3J0KCJqc2RvbSIpOwogICAgICAgICAgICBsZXQgeyBKU0RPTSB9ID0ganNkb207CiAgICAgICAgICAgIGxldCBkb20gPSBuZXcgSlNET00oaHRtbERhdGEpOwogICAgICAgICAgICBkb2N1bWVudCA9IGRvbS53aW5kb3cuZG9jdW1lbnQ7CiAgICAgICAgICAgIHJldHVybiBpbnNlcnRRdWVzdGlvbm5haXJlTGluayhjYXRlZ29yaWVzLCBsYW5nLCBkb2N1bWVudCwgcmVzcG9uc2UpOwogICAgICAgICAgICAvL2xpc3RPZkNhdGVnb3JpZXMsIGVuaGFuY2VUYWcsIGRvY3VtZW50LCByZXNwb25zZQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRvY3VtZW50ID0gd2luZG93LmRvY3VtZW50OwogICAgICAgICAgICByZXR1cm4gaW5zZXJ0UXVlc3Rpb25uYWlyZUxpbmsoY2F0ZWdvcmllcywgbGFuZywgZG9jdW1lbnQsIHJlc3BvbnNlKTsKICAgICAgICB9CiAgICB9Owp9OwoKCmZ1bmN0aW9uIGdldFJlcG9ydChsYW5nID0gImVuIikgewogICAgY29uc29sZS5sb2coIkdlbmVyYXRpbmcgcmVwb3J0IGluIGxhbmd1YWdlOiIsIGxhbmcpOwogICAgcmV0dXJuIHsgbWVzc2FnZTogZ2V0RXhwbGFuYXRpb24obGFuZyksIHN0YXR1czogIiIgfTsKfQoKLy8gLS0tIEdldCB1c2VyLWZhY2luZyByZXBvcnQgc2VudGVuY2UgaW4gdGhlIHNlbGVjdGVkIGxhbmd1YWdlIC0tLQpmdW5jdGlvbiBnZXRFeHBsYW5hdGlvbihsYW5ndWFnZSA9ICJlbiIpIHsKICAgIC8vIE5vcm1hbGl6ZSBsYW5ndWFnZSB0byBsb3dlcmNhc2UKICAgIGxhbmd1YWdlID0gbGFuZ3VhZ2U/LnRvTG93ZXJDYXNlKCkgfHwgImVuIjsKCiAgICAvLyBTaW1wbGUsIHBhdGllbnQtZnJpZW5kbHkgZXhwbGFuYXRpb25zIGluIGRpZmZlcmVudCBsYW5ndWFnZXMKICAgIGNvbnN0IGV4cGxhbmF0aW9uc0FkZGVkID0gewogICAgICAgIGVuOiAiQSBsaW5rIHRvIGEgc2FmZXR5IHF1ZXN0aW9ubmFpcmUgaGFzIGJlZW4gYWRkZWQgdG8gaGVscCB5b3UgYXNzZXNzIGlmIHRoaXMgbWVkaWNhdGlvbiBpcyBzYWZlIGZvciB5b3UuIiwKICAgICAgICBlczogIlNlIGhhIGHDsWFkaWRvIHVuIGVubGFjZSBhIHVuIGN1ZXN0aW9uYXJpbyBkZSBzZWd1cmlkYWQgcGFyYSBheXVkYXJsZSBhIGV2YWx1YXIgc2kgZXN0ZSBtZWRpY2FtZW50byBlcyBzZWd1cm8gcGFyYSB1c3RlZC4iLAogICAgICAgIGZyOiAiVW4gbGllbiB2ZXJzIHVuIHF1ZXN0aW9ubmFpcmUgZGUgc8OpY3VyaXTDqSBhIMOpdMOpIGFqb3V0w6kgcG91ciB2b3VzIGFpZGVyIMOgIMOpdmFsdWVyIHNpIGNlIG3DqWRpY2FtZW50IGVzdCBzw7tyIHBvdXIgdm91cy4iLAogICAgICAgIGRlOiAiRWluIExpbmsgenUgZWluZW0gU2ljaGVyaGVpdHNmcmFnZWJvZ2VuIHd1cmRlIGhpbnp1Z2Vmw7xndCwgdW0gSWhuZW4genUgaGVsZmVuIGZlc3R6dXN0ZWxsZW4sIG9iIGRpZXNlcyBNZWRpa2FtZW50IGbDvHIgU2llIHNpY2hlciBpc3QuIiwKICAgICAgICBpdDogIsOIIHN0YXRvIGFnZ2l1bnRvIHVuIGNvbGxlZ2FtZW50byBhIHVuIHF1ZXN0aW9uYXJpbyBkaSBzaWN1cmV6emEgcGVyIGFpdXRhcnRpIGEgdmFsdXRhcmUgc2UgcXVlc3RvIGZhcm1hY28gw6ggc2ljdXJvIHBlciB0ZS4iLAogICAgICAgIHB0OiAiRm9pIGFkaWNpb25hZG8gdW0gbGluayBwYXJhIHVtIHF1ZXN0aW9uw6FyaW8gZGUgc2VndXJhbsOnYSBwYXJhIGFqdWTDoS1sbyBhIGF2YWxpYXIgc2UgZXN0ZSBtZWRpY2FtZW50byDDqSBzZWd1cm8gcGFyYSB2b2PDqi4iLAogICAgICAgIG5sOiAiRXIgaXMgZWVuIGxpbmsgbmFhciBlZW4gdmVpbGlnaGVpZHN2cmFnZW5saWpzdCB0b2VnZXZvZWdkIG9tIHUgdGUgaGVscGVuIGJlb29yZGVsZW4gb2YgZGl0IG1lZGljaWpuIHZlaWxpZyB2b29yIHUgaXMuIgogICAgfTsKCiAgICBjb25zdCBleHBsYW5hdGlvbnNOb3RBZGRlZCA9IHsKICAgICAgICBlbjogIllvdXIgcHJvZmlsZSBkb2VzIG5vdCBtYXRjaCB0aGUgY29uZGl0aW9ucyB0byBhZGQgYSBxdWVzdGlvbm5haXJlIGxpbmsuIiwKICAgICAgICBlczogIlN1IHBlcmZpbCBubyBjb2luY2lkZSBjb24gbGFzIGNvbmRpY2lvbmVzIHBhcmEgYcOxYWRpciB1biBlbmxhY2UgYWwgY3Vlc3Rpb25hcmlvLiIsCiAgICAgICAgZnI6ICJWb3RyZSBwcm9maWwgbmUgY29ycmVzcG9uZCBwYXMgYXV4IGNvbmRpdGlvbnMgcG91ciBham91dGVyIHVuIGxpZW4gdmVycyBsZSBxdWVzdGlvbm5haXJlLiIsCiAgICAgICAgZGU6ICJJaHIgUHJvZmlsIGVyZsO8bGx0IG5pY2h0IGRpZSBCZWRpbmd1bmdlbiBmw7xyIGRhcyBIaW56dWbDvGdlbiBlaW5lcyBGcmFnZWJvZ2VuLUxpbmtzLiIsCiAgICAgICAgaXQ6ICJJbCB0dW8gcHJvZmlsbyBub24gY29ycmlzcG9uZGUgYWxsZSBjb25kaXppb25pIHBlciBhZ2dpdW5nZXJlIHVuIGNvbGxlZ2FtZW50byBhbCBxdWVzdGlvbmFyaW8uIiwKICAgICAgICBwdDogIlNldSBwZXJmaWwgbsOjbyBjb3JyZXNwb25kZSDDoHMgY29uZGnDp8O1ZXMgcGFyYSBhZGljaW9uYXIgdW0gbGluayBwYXJhIG8gcXVlc3Rpb27DoXJpby4iLAogICAgICAgIG5sOiAiVXcgcHJvZmllbCB2b2xkb2V0IG5pZXQgYWFuIGRlIHZvb3J3YWFyZGVuIG9tIGVlbiB2cmFnZW5saWpzdGxpbmsgdG9lIHRlIHZvZWdlbi4iCiAgICB9OwoKICAgIC8vIFJldHVybiBleHBsYW5hdGlvbiBiYXNlZCBvbiB3aGV0aGVyIGxpbmsgd2FzIGFkZGVkLCBpbiB0aGUgZVBJIGxhbmd1YWdlCiAgICBpZiAobGlua0FkZGVkKSB7CiAgICAgICAgcmV0dXJuIGV4cGxhbmF0aW9uc0FkZGVkW2xhbmd1YWdlXSB8fCBleHBsYW5hdGlvbnNBZGRlZC5lbjsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGV4cGxhbmF0aW9uc05vdEFkZGVkW2xhbmd1YWdlXSB8fCBleHBsYW5hdGlvbnNOb3RBZGRlZC5lbjsKICAgIH0KfQoKLy8gLS0tIEV4cG9ydGVkIEFQSSAtLS0KcmV0dXJuIHsKICAgIGVuaGFuY2U6IGVuaGFuY2UsCiAgICBnZXRTcGVjaWZpY2F0aW9uOiBnZXRTcGVjaWZpY2F0aW9uLAogICAgZXhwbGFuYXRpb246IChsYW5ndWFnZSkgPT4gZ2V0RXhwbGFuYXRpb24obGFuZ3VhZ2UgfHwgbGFuZyB8fCAiZW4iKSwKICAgIHJlcG9ydDogKGxhbmd1YWdlKSA9PiBnZXRSZXBvcnQobGFuZ3VhZ2UgfHwgbGFuZyB8fCAiZW4iKSwKfTsKCgo="
    }
  ]
}