name: Test and Upload Lenses

on:
  push:
    branches:
      - main
      - dev
    tags:
      - 'v*'

jobs:
  # This workflow will:
  # 1. Check lens integrity
  # 2. Test lenses with batch-test
  # 3. Upload to dev server on push to any branch
  # 4. Upload to prod server only when a tag is pushed
  upload-lenses:
    uses: Gravitate-Health/reusable-workflows/.github/workflows/lenses-upload.yaml@main
    secrets: inherit  # Pass secrets from calling workflow (required for FHIR_SERVER_URL_DEV/PROD)
    with:
      # Only pass tag when the trigger is actually a tag push
      tag: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || '' }}
      
      # Optional: Skip integrity check (default: false). 
      # Integrity check is based on basic js to bundle consistency, skip if using complex lens compilation.
      # skip_integrity_check: true
      
      # Optional: Skip testing (default: false).
      # Strongly recommended to keep testing enabled unless you have a specific reason to skip.
      # skip_testing: true
